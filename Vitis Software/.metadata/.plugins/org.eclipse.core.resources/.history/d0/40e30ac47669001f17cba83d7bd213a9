#include "i2c_core.h"


/****** Helper Functions ********/


/**
 * @brief Probes status flag of the I2C Core to check if it is ready
 * @note ready flag indicates it is either in a hold state or idle state waiting for a command
 */
static uint32_t i2c_ready(i2c_handle_t* self)
{
	return (uint32_t)((io_read(self->base_addr, RD_REG) >> 8) & 0x01);
}

/**
 * @brief Sends  a start command to the i2c master
 */
static void i2c_start(i2c_handle_t* self)
{
	//Wait for the i2c core to be ready
	while(!i2c_ready());
	io_write(self->base_addr, WR_REG, I2C_START);
}

/**
 * @brief Send a restart condition to the i2c master
 */
static void i2c_restart(i2c_handle_t* self)
{
	//Wait for i2c core to be ready
	while(!i2c_ready());
	io_write(self->base_addr, WR_REG, I2C_RESTART);
}

/**
 * @brief Send a stop request to the i2c master
 */
static void i2c_stop(i2c_handle_t* self)
{
	//Wait for ready flag
	while(!i2c_ready());
	io_write(self->base_addr, WR_REG, I2C_RESTART);
}

/**
 * @brief Write a singular byte of data on the i2c master
 * @retval 0 indicates unsuccessful transmission and 1 indicates successful transmission
 */
static int i2c_write_byte(i2c_handle_t* self, uint8_t data)
{
	int acc_data;

	//Append the command with the data to send
	acc_data = data | I2C_WR_CMD;
	//Wait for the ready flag to be raised
	while(!i2c_ready());
	//Once ready, write the data into the core
	io_write(self->base_addr, WR_REG, acc_data);
	//Once again wait for a ready flag
	while(!i2c_ready());
	//Return the ack bit to determine tis this was succesfull
	return ((io_read(self->base_addr, RD_REG) >> 9) & 0x01);
}

/**
 * @brief Read a singular byte of data from the i2c Master
 */
static int i2c_read_byte(i2c_handle_t* self, uint8_t data)
{
	int acc_data;

	acc_data = data | I2C_RD_CMD;
	//Wait for the ready flag
	while(!i2c_read());
	//Write data to the i2c master
	io_write(self->base_addr, WR_REG, acc_data);
	//Once again wait for rdy flag
	while(!i2c_ready());
	//return value read
	return (io_read(self->base_addr, RD_REG) & 0xff);
}


/****** Main methods ********/


void i2c_set_freq(i2c_handle_t* self, int i2c_freq)
{
	uint32_t dvsr;
	//Calculate the dvsr based off desired freq
	dvsr = (uint32_t)((SYS_CLK_FREQ*1000000)/(i2c_freq * 4));
	//Write dvsr value
	io_write(self->base_addr, DVSR_REG, dvsr);
}


void i2c_init(i2c_handle_t* self, uint32_t core_addr)
{
	self->base_addr = core_addr;
	//Init freq to 100KHz
	i2c_set_freq(100000);
}

int i2c_read_transaction(i2c_handle_t* self, uint8_t addr, uint8_t *bytes, int num, int rstart)
{
	//Initialize start condition & wait for ready flag
	i2c_start(self);
	while(!i2c_ready());
}


